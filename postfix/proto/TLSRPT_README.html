<!doctype html public "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">

<html>

<head>

<title>Postfix TLSRPT notification Howto</title>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel='stylesheet' type='text/css' href='postfix-doc.css'>

</head>

<body>

<h1><img src="postfix-logo.jpg" width="203" height="98" ALT="">Postfix TLSRPT Howto</h1>

<hr>

<h2> TOC </h2>

<ul>

<li> <a href="#intro"> Introduction </a> </li>
<li> <a href="#building"> Building Postfix with TLSRPT support </a>
<li> <a href="#using"> Using TLSRPT </a> </li>
<li> <a href="#mta-sts"> MTA-STS Support via smtp_tls_policy_maps </a> </li>
<li> <a href="#limitations"> Limitations </a></li>
<li> <a href="#credits"> Credits </a> </li>

</ul>

<h2> <a name="intro"> Introduction </a> </h2>

<p> The TLSRPT protocol is defined in RFC 8460. With this, an email
receiving domain can publish a policy in DNS to request daily summary
reports for successful and failed TLS connections to that domain.
Support for TLSRPT was added in Postfix 3.10. </p>

<p> When Postfix TLSRPT support is enabled (with "smtp_tlsrpt_enable
= yes"), the Postfix SMTP and TLS clients engines will generate
"success" and "failure" events, and will pass those events to a
TLSRPT client library and report generator that are maintained by
sys4. The Postfix implementation supports both DANE (Postfix built-in)
and MTA-STS (through an smtp_tls_policy_maps plug-in). </p>

<p> The high-level diagram shows how Postfix events are reported
to domains that publish a TLSRPT policy.

<blockquote>

<table>

<tr> <td bgcolor="#f0f0ff"> Postfix SMTP and<br> TLS client engines
</td> <td> <tt> --&gt; </tt> </td>

<td bgcolor="#f0f0ff"> TLSRPT client library </td> <td> <tt> --&gt;
</tt> </td>

<td bgcolor="#f0f0ff"> TLSRPT report generator </td> <td> <tt>
--&gt; </tt> </td>

<td bgcolor="#f0f0ff"> Email or HTTP summary </td> </tr>

</table>

</blockquote>

<p> The Postfix smtp(8) client process implements the SMTP client
engine.  With "smtp_tls_connection_reuse = no", the smtp(8) client
process also implements the TLS client engine. With
"smtp_tls_connection_reuse = yes", the smtp(8) client process
delegates TLS processing to a Postfix tlsproxy(8) process. Either
way, Postfix will generate the exact same TLSRPT events. </p>

<h2> <a name="building"> Building Postfix with TLSRPT support </a>
</h2>

<p> These instructions assume that you build Postfix from source
code as described in the INSTALL document. Some modification may
be required if you build Postfix from a vendor-specific source
package. </p>

<p> The Postfix TLSRPT client builds on a TLSRPT client library
whose source code can be obtained from: </p>

<blockquote>
 <p> https://github.com/sys4/tlsrpt </p>
</blockquote>

<p> The library is typically installed as a header file in
/usr/local/include/tlsrpt.h and an object library in
/usr/local/lib/libtlsrpt.a or /usr/local/lib/libtlsrpt.so. The
actual pathnames will depend on OS platform conventions. </p>

<p> In order to build Postfix with TLSRPT support, you will need
to add compiler options <b>-DUSE_TLSRPT</b> (to build with TLSRPT
support), and <b>-I</b> (with the directory containing the tlsrpt.h
header file), and you will need to add linker options to link with
the TLSRPT client library, for example: </p>

<blockquote>
<pre>
make -f Makefile.init makefiles \
  "CCARGS=-DUSE_TLSRPT -I/usr/local/include" \
  "AUXLIBS=-L/usr/local/lib -ltlsrpt"
</pre>
</blockquote>

<p> Then, just run 'make'. </p>

<blockquote>

<p> Note: if your build command line already has CCARGS or AUXLIBS
options, then simply append the above options to the existing CCARGS
or AUXLIBS values. </p>

</blockquote>

<h2> <a name="using"> Using TLSRPT </a> </h2>

<p> After installing Postfix TLSRPT support, you can enable TLSRPT
support in main.cf like this: </p>

<blockquote>
<pre>
smtp_tlsrpt_enable = yes
smtp_tlsrpt_socket_name = /path/to/socket
</pre>
</blockquote>

<p> The smtp_tlsrpt_socket_name parameter specifies an absolute
pathname, or a pathname that is relative to $queue_directory. </p>

<p> A good socket location would be under $queue_directory/run/tlsrpt
or $queue_directory/var/run/tlsrpt. These can then be configured
in Postfix as a relative pathname (run/tlsrpt/tlsrpt.sock or
var/run/tlsrpt/tlsrpt.sock) so that the same name will work with
and without Postfix chroot support. Do not specify a location under
directory that is already used by Postfix programs. Only Postfix
programs should create sockets there. </p>

<h2> <a name="mta-sts"> MTA-STS Support via smtp_tls_policy_maps
</a></h2>

<p> Postfix supports MTA-STS though an smtp_tls_policy_maps policy
plugin. Postfix TLSRPT support expects a response with the usual
security level and matching requirements, plus any applicable
name=value attributes described below. Specify { name = value }
when a value may contain whitespace. </p>

<blockquote>

<p> Note 1: Postfix 3.10 and later will accept these attributes in
an MTA-STS response even if TLSRPT support is disabled (at build
time or run time), but it will not use most attributes except
<tt>ttl</tt> and <tt>policy_failure</tt>.  </p>

<p> Note 2: It is an error to specify these attributes for a non-STS
policy. </p>

</blockquote>

<p> The examples in the table apply to the MTA-STS policy example
given in https://datatracker.ietf.org/doc/html/rfc8460#section-4.5.
<p>

<ul>

<li> <p> <tt> policy_type=<i>type</i> </tt>

<p> Specify <tt>sts</tt> or <tt>no-policy-found</tt>. </p> </li>

<li> <p> <tt> policy_domain=<i>name</i> </tt> </p>

<p> The domain that the MTA-STS policy applies to. </p> </li>

<li> <p> <tt> policy_ttl=<i>time</i> </tt> </p>

<p> How long (in seconds) a Postfix SMTP client process will cache
the MTA-STS plugin response.  </p> </li>

<li> <p> <tt> { policy_string = <i>value</i> } </tt> </p>

<p> Specify one <tt>policy_string</tt> instance for each MTA-STS
policy feature, enclosed inside "{" and "}" to protect whitespace
in attribute values. </p>

<p> Example: </p>

<blockquote>
<pre>
{ policy_string = version: STSv1 }, { policy_string = mode: testing }, ...
</pre> 
</blockquote> 

<p> This form ignores whitespace after the opening "{", around the "=",
and before the closing "}".</p> </li>

<li> <p> <tt> mx_host_pattern=<i>pattern</i> </tt> </p>

<p> Specify one <tt>mx_host_pattern</tt> instance for each "mx:" feature
in the MTA-STS policy. </p>

<p> Example: </p>

<blockquote>
<pre>
mx_host_pattern=mx1.example.com, mx_host_pattern=mx2.example.com, ...
</pre>
</blockquote>
</li>

<li> <p> <tt> policy_failure=<i>type</i> </tt> </p>

<p> If specified, forces MTA-STS policy enforcement to fail with
the indicated error, even if a server certificate would satisfy
conventional PKI constraints. </p>

<p> Valid errors are <tt>sts-policy-fetch-error, sts-policy-invalid</tt>,
<tt>sts-webpki-invalid</tt>, or the less informative
<tt>validation-failure</tt>. </p>

<p> Example: </p>

<blockquote>
<pre>
policy_failure=sts-webpki-invalid
</pre>
</blockquote>
</li>

</ul>

<h2> <a name="limitations"> Limitations </a></h2>

<p> The following limitations exist primarily because some errors
may be reported by a Postfix smtp(8) client process, and some errors
by a Postfix tlsproxy(8) process. It is too difficult to propagate
TLSRPT client library state between processes.</p>

<p> The Postfix TLSRPT client reports one final status (either
'success' or 'failure') for each MTA that it is able to connect to.
It cannot report a final status 'success' with some recoverable
'failure'. Specifically: </p>

<ul>

<li> <p> The Postfix TLSRPT client can report either successful TLS
policy compliance, or an unrecoverable failure that prevents TLS
policy compliance (examples: all TLSA records are unusable, or some
PKI error during certificate verification). <p> </li>

<li> <p> The Postfix TLSRPT client must not be used to report a
potentially recoverable failure such as a non-parsable TLSA record,
because some other TLSA record for the same host may still allow
successful TLS policy compliance. </p> </li>

</ul>

<h2> <a name="credits"> Credits </a> </h2>

<ul>

<li> The TLSRPT client library and report generator are implemented
and maintained by sys4 (sys4.de). </li>

<li> Wietse Venema implemented the integration with Postfix.
</li>

</ul>

</body>

</html>
