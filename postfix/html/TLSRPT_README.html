<!doctype html public "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">

<html>

<head>

<title>Postfix TLSRPT notification Howto</title>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel='stylesheet' type='text/css' href='postfix-doc.css'>

</head>

<body>

<h1><img src="postfix-logo.jpg" width="203" height="98" ALT="">Postfix TLSRPT Howto</h1>

<hr>

<h2> Table of Contents </h2>

<ul>

<li> <a href="#intro"> Introduction </a> </li>
<li> <a href="#building"> Building Postfix with TLSRPT support </a>
<li> <a href="#using"> Using TLSRPT </a> </li>
<li> <a href="#mta-sts"> MTA-STS Support via smtp_tls_policy_maps </a> </li>
<li> <a href="#limitations"> Limitations </a></li>
<li> <a href="#credits"> Credits </a> </li>

</ul>

<h2> <a name="intro"> Introduction </a> </h2>

<p> The TLSRPT protocol is defined in <a href="https://tools.ietf.org/html/rfc8460">RFC 8460</a>. With this, an email
receiving domain can publish a policy in DNS to request daily summary
reports for successful and failed TLS connections to that domain.
Support for TLSRPT was added in Postfix 3.10. </p>

<p> A policy example looks like this: </p>

<blockquote>
<pre>
_smtp._tls.example.com. IN TXT "v=TLSRPTv1; rua=mailto:smtp-tls-report@example.com"
</pre>
</blockquote>

<p> Translation: email sending systems are requested to generate daily
summaries of successful and failed SMTP over TLS connections to domain
<tt>example.com</tt>, and to report those summaries via email to the
specified address. Instead of <tt>mailto:</tt>, a policy may specify an
<tt>https:</tt> destination. </p>

<p> The high-level diagram shows how Postfix reports  summaries to
domains that publish a TLSRPT policy.

<blockquote>

<table>

<tr> <td bgcolor="#f0f0ff"> Postfix SMTP and<br> TLS client engines
</td> <td> <tt> --&gt; </tt> </td>

<td bgcolor="#f0f0ff"> TLSRPT client library </td> <td> <tt> --&gt;
</tt> </td>

<td bgcolor="#f0f0ff"> TLSRPT report generator </td> <td> <tt>
--&gt; </tt> </td>

<td bgcolor="#f0f0ff"> Email or HTTP summary </td> </tr>

</table>

</blockquote>

<p> When Postfix TLSRPT support is enabled (with "<a href="postconf.5.html#smtp_tlsrpt_enable">smtp_tlsrpt_enable</a>
= yes"), the Postfix SMTP and TLS clients engines will generate
"success" and "failure" events, and will pass those events to a
TLSRPT client library and report generator that are maintained by
sys4. The Postfix implementation supports both DANE (Postfix built-in)
and MTA-STS (through an <a href="postconf.5.html#smtp_tls_policy_maps">smtp_tls_policy_maps</a> plug-in). </p>

<p> The Postfix <a href="smtp.8.html">smtp(8)</a> client process implements the SMTP client
engine. With "<a href="postconf.5.html#smtp_tls_connection_reuse">smtp_tls_connection_reuse</a> = no", the <a href="smtp.8.html">smtp(8)</a> client
process also implements the TLS client engine. With
"<a href="postconf.5.html#smtp_tls_connection_reuse">smtp_tls_connection_reuse</a> = yes", the <a href="smtp.8.html">smtp(8)</a> client process
delegates TLS processing to a Postfix <a href="tlsproxy.8.html">tlsproxy(8)</a> process. Either
way, Postfix will generate the exact same TLSRPT events. </p>

<h2> <a name="building"> Building Postfix with TLSRPT support </a>
</h2>

<p> These instructions assume that you build Postfix from source
code as described in the <a href="INSTALL.html">INSTALL</a> document. Some modification may
be required if you build Postfix from a vendor-specific source
package. </p>

<p> The Postfix TLSRPT client builds on a TLSRPT client library
whose source code can be obtained from: </p>

<blockquote>
 <p> <a href="https://github.com/sys4/tlsrpt">https://github.com/sys4/tlsrpt</a> </p>
</blockquote>

<p> The library is typically installed as a header file in
/usr/local/include/tlsrpt.h and an object library in
/usr/local/lib/libtlsrpt.a or /usr/local/lib/libtlsrpt.so. The
actual pathnames will depend on OS platform conventions. </p>

<p> In order to build Postfix with TLSRPT support, you will need
to add compiler options <b>-DUSE_TLSRPT</b> (to build with TLSRPT
support), and <b>-I</b> (with the directory containing the tlsrpt.h
header file), and you will need to add linker options to link with
the TLSRPT client library, for example: </p>

<blockquote>
<pre>
make -f Makefile.init makefiles \
  "CCARGS=-DUSE_TLSRPT -I/usr/local/include" \
  "AUXLIBS=-L/usr/local/lib -ltlsrpt"
</pre>
</blockquote>

<p> Then, just run 'make'. </p>

<blockquote>

<p> Note: if your build command line already has CCARGS or AUXLIBS
options, then simply append the above options to the existing CCARGS
or AUXLIBS values. </p>

</blockquote>

<h2> <a name="using"> Using TLSRPT </a> </h2>

<p> After installing Postfix TLSRPT support, you can enable TLSRPT
support in <a href="postconf.5.html">main.cf</a> like this: </p>

<blockquote>
<pre>
<a href="postconf.5.html#smtp_tlsrpt_enable">smtp_tlsrpt_enable</a> = yes
<a href="postconf.5.html#smtp_tlsrpt_socket_name">smtp_tlsrpt_socket_name</a> = /path/to/socket
</pre>
</blockquote>

<p> The <tt><a href="postconf.5.html#smtp_tlsrpt_socket_name">smtp_tlsrpt_socket_name</a></tt> parameter specifies an
absolute pathname, or a pathname that is relative to
<tt>$<a href="postconf.5.html#queue_directory">queue_directory</a></tt>. </p>

<blockquote>

<p> Note: the socket location is still to be determined. A good
socket location would be under <tt>$<a href="postconf.5.html#queue_directory">queue_directory</a></tt>, for
example: (<tt><a href="postconf.5.html#smtp_tlsrpt_socket_name">smtp_tlsrpt_socket_name</a> = run/tlsrpt/tlsrpt.sock</tt>
or <tt><a href="postconf.5.html#smtp_tlsrpt_socket_name">smtp_tlsrpt_socket_name</a> = var/run/tlsrpt/tlsrpt.sock</tt>).
Such names will work with and without Postfix chroot support. Do
not specify a location under a directory (<tt>private, public,
...</tt>) that is already used by Postfix programs. Only Postfix
programs should create sockets there. </p>

</blockquote>

<p> For obvious reasons, <a href="https://tools.ietf.org/html/rfc8460">RFC 8460</a> suggests not to enforce strict
TLS security when sending daily success/failure summaries via email. Postfix
currently does not have a mechanism to request this when submitting
an email message. For initial tests a transport map may take care
of this. </p>

<blockquote>
<pre>
/etc/postfix/<a href="postconf.5.html">main.cf</a>:
    <a href="postconf.5.html#transport_maps">transport_maps</a> = <a href="DATABASE_README.html#types">hash</a>:/etc/postfix/transport
&nbsp
/etc/postfix/transport:
    /^\Qsts-reports@gmail.com\E$/       allow-plaintext
    /^\Qsmtp-tls-report@sys4.de\E$/     allow-plaintext
    ...
&nbsp
/etc/postfix/<a href="master.5.html">master.cf</a>:
    allow-plaintext .. .. .. .. .. .. .. smtp
        -o <a href="postconf.5.html#smtp_tls_security_level">smtp_tls_security_level</a>=may
        -o <a href="postconf.5.html#smtp_tls_policy_maps">smtp_tls_policy_maps</a>=
</pre>
</blockquote>

<p> The <tt>^</tt> and <tt>$</tt> prevent false matches, and the
<tt>\Q</tt> and <tt>\E</tt> disable special characters. </p>

<h2> <a name="mta-sts"> MTA-STS Support via smtp_tls_policy_maps
</a></h2>

<p> Postfix supports MTA-STS though an <a href="postconf.5.html#smtp_tls_policy_maps">smtp_tls_policy_maps</a> policy
plugin. Postfix expects a response with the usual security level and
matching requirements, plus any applicable name=value attributes described
below. Specify { name = value } when a value may contain whitespace. </p>

<blockquote>

<p> Note 1: Postfix 3.10 and later will accept these attributes in
an MTA-STS response even if TLSRPT support is disabled (at build
time or run time). With TLSRPT support turned off, Postfix
will use the <tt>ttl</tt> and <tt>policy_failure</tt> attributes,
and will ignore the attributes that are used only for TLSRPT. </p>

<p> Note 2: It is an error to specify these attributes for a non-STS
policy. </p>

</blockquote>

<p> The examples in the table apply to the MTA-STS policy example
given in <a href="https://datatracker.ietf.org/doc/html/rfc8460#section-4.5">https://datatracker.ietf.org/doc/html/rfc8460#section-4.5</a>.
<p>

<ul>

<li> <p> <tt> policy_type=<i>type</i> </tt>

<p> Specify <tt>sts</tt> or <tt>no-policy-found</tt>. </p> </li>

<li> <p> <tt> policy_domain=<i>name</i> </tt> </p>

<p> The domain that the MTA-STS policy applies to. </p> </li>

<li> <p> <tt> policy_ttl=<i>time</i> </tt> </p>

<p> How long (in seconds) a Postfix SMTP client process will cache
the MTA-STS plugin response. </p> </li>

<li> <p> <tt> { policy_string = <i>value</i> } </tt> </p>

<p> Specify one <tt>policy_string</tt> instance for each MTA-STS
policy feature, enclosed inside "{" and "}" to protect whitespace
in attribute values. </p>

<p> Example: </p>

<blockquote>
<pre>
{ policy_string = version: STSv1 } { policy_string = mode: testing } ...
</pre> 
</blockquote> 

<p> This form ignores whitespace after the opening "{", around the "=",
and before the closing "}".</p> </li>

<li> <p> <tt> mx_host_pattern=<i>pattern</i> </tt> </p>

<p> Specify one <tt>mx_host_pattern</tt> instance for each "mx:" feature
in the MTA-STS policy. </p>

<p> Example: </p>

<blockquote>
<pre>
mx_host_pattern=mx1.example.com mx_host_pattern=mx2.example.com ...
</pre>
</blockquote>
</li>

<li> <p> <tt> policy_failure=<i>type</i> </tt> </p>

<p> If specified, forces MTA-STS policy enforcement to fail with
the indicated error, even if a server certificate would satisfy
conventional PKI constraints. </p>

<p> Valid errors are <tt>sts-policy-fetch-error, sts-policy-invalid</tt>,
<tt>sts-webpki-invalid</tt>, or the less informative
<tt>validation-failure</tt>. </p>

<p> Example: </p>

<blockquote>
<pre>
policy_failure=sts-webpki-invalid
</pre>
</blockquote>
</li>

</ul>

<h2> <a name="limitations"> Limitations </a></h2>

<p> The Postfix TLSRPT implementation reports at most one final TLS
handshake status (either 'success' or 'failure') per connection.
Postfix TLSRPT cannot report a failure and then later report a final
status of 'success' for that same connection. The reason is that
it's too complicated to filter TLS errors and to report error details
from the TLS engine back to the SMTP protocol engine. It just is
not how Postfix works internally. </p>

<p> The Postfix TLSRPT implementation reports only TLS handshake
success or failure. It does not report failure to connect, or
connections that break after a successful TLS handshake. </p>

<h2> <a name="credits"> Credits </a> </h2>

<ul>

<li> The TLSRPT client library and report generator are implemented
and maintained by sys4. </li>

<li> Wietse Venema implemented the integration with Postfix.
</li>

</ul>

</body>

</html>
